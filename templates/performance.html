{% extends "base.html" %}

{% block title %}Performance - T'ELEFAN MES 4.0{% endblock %}

{% block breadcrumbs %}
<div class="border-t border-zinc-100 bg-zinc-50/50">
    <div class="max-w-[1400px] mx-auto px-4 py-2 text-sm">
        <a href="{{ url_for('main.dashboard') }}" class="text-zinc-400 hover:text-zinc-600 transition-colors">Accueil</a>
        <span class="mx-1.5 text-zinc-300">/</span>
        <span class="font-medium text-zinc-900">Performance</span>
    </div>
</div>
{% endblock %}

{% block content %}
<h2 class="text-lg font-semibold tracking-tight text-zinc-900 mb-6">Performance</h2>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- OEE Gauge -->
    <div class="bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1.5 kpi-bar-perf"></div>
        <div class="p-6">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">
                OEE - Taux de Rendement Global
            </h3>
            <div id="oee-gauge" class="plotly-chart" style="height: 260px;"></div>
            <!-- Sous-detail Dispo / Perf / Qualite -->
            <div class="grid grid-cols-3 gap-4 mt-4 pt-4 border-t border-zinc-100">
                <div class="text-center">
                    <p class="text-[10px] text-zinc-400 uppercase tracking-wide">Disponibilite</p>
                    <p class="text-lg font-semibold font-mono text-zinc-900">{{ oee.availability }}%</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] text-zinc-400 uppercase tracking-wide">Performance</p>
                    <p class="text-lg font-semibold font-mono text-zinc-900">{{ oee.performance }}%</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] text-zinc-400 uppercase tracking-wide">Qualite</p>
                    <p class="text-lg font-semibold font-mono text-zinc-900">{{ oee.quality }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Taux d'utilisation machine (Bar Chart) -->
    <div class="bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1.5 kpi-bar-perf"></div>
        <div class="p-6">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">
                Taux d'utilisation machine
            </h3>
            <div id="utilization-chart" class="plotly-chart" style="height: 320px;"></div>
        </div>
    </div>

    <!-- Cadence reelle (Line Chart) -->
    <div class="bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1.5 kpi-bar-perf"></div>
        <div class="p-6">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">
                Cadence reelle
            </h3>
            <div id="throughput-chart" class="plotly-chart" style="height: 280px;"></div>
        </div>
    </div>

    <!-- Temps moyen de cycle (Large Value) -->
    <div class="bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1.5 kpi-bar-perf"></div>
        <div class="p-6 flex flex-col items-center justify-center min-h-[340px]">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-8">
                Temps moyen de cycle
            </h3>
            <div class="flex items-baseline gap-2">
                <span class="text-7xl font-bold tracking-tighter font-mono text-zinc-900">
                    {{ cycle_time.value }}
                </span>
                <span class="text-xl text-zinc-400 font-medium">s</span>
            </div>
            {% if cycle_time.status == 'warning' %}
            <div class="mt-4 flex items-center gap-1.5">
                <span class="alert-blink">
                    <svg class="w-4 h-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>
                </span>
                <span class="text-xs font-medium text-amber-600">Au-dessus du seuil nominal</span>
            </div>
            {% endif %}
            <p class="text-sm text-zinc-400 mt-3">
                Calcule sur {{ cycle_time.count }} etapes de production
            </p>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // --- OEE Gauge ---
    var oeeValue = {{ oee.value | tojson }};
    Plotly.newPlot('oee-gauge', [{
        type: 'indicator',
        mode: 'gauge+number',
        value: oeeValue,
        number: {
            suffix: '%',
            font: { size: 42, color: '#18181b' }
        },
        gauge: {
            axis: {
                range: [0, 100],
                tickwidth: 1,
                tickcolor: '#d4d4d8',
                dtick: 20
            },
            bar: { color: '#dc2626', thickness: 0.75 },
            bgcolor: '#f4f4f5',
            borderwidth: 0,
            steps: [
                { range: [0, 60], color: '#fef2f2' },
                { range: [60, 85], color: '#fffbeb' },
                { range: [85, 100], color: '#f0fdf4' }
            ],
            threshold: {
                line: { color: '#18181b', width: 3 },
                thickness: 0.8,
                value: 85
            }
        }
    }], {
        margin: { t: 10, b: 10, l: 40, r: 40 },
        paper_bgcolor: 'transparent',
        height: 260
    }, { responsive: true, displayModeBar: false });

    // --- Utilization Bar Chart ---
    var utilData = {{ utilization.by_machine | tojson }};
    if (utilData && utilData.length > 0) {
        Plotly.newPlot('utilization-chart', [{
            type: 'bar',
            x: utilData.map(function(d) { return d.name; }),
            y: utilData.map(function(d) { return d.value; }),
            marker: {
                color: utilData.map(function(d) {
                    if (d.value > 90) return '#dc2626';
                    if (d.value > 70) return '#f87171';
                    return '#fca5a5';
                }),
                line: { width: 0 }
            },
            text: utilData.map(function(d) { return d.value.toFixed(1) + '%'; }),
            textposition: 'outside',
            textfont: { size: 10, color: '#71717a' },
            hovertemplate: '%{x}<br>Utilisation: %{y:.1f}%<extra></extra>'
        }], {
            xaxis: {
                tickfont: { size: 9, color: '#71717a' },
                tickangle: -35
            },
            yaxis: {
                title: { text: 'Utilisation (%)', font: { size: 10, color: '#71717a' } },
                range: [0, 105],
                tickfont: { size: 10, color: '#71717a' },
                gridcolor: '#f4f4f5'
            },
            margin: { t: 10, b: 90, l: 45, r: 10 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            bargap: 0.35,
            height: 320
        }, { responsive: true, displayModeBar: false });
    }

    // --- Throughput Line Chart ---
    var tpData = {{ throughput.monthly | tojson }};
    if (tpData && tpData.length > 0) {
        Plotly.newPlot('throughput-chart', [{
            type: 'scatter',
            mode: 'lines+markers',
            x: tpData.map(function(d) { return d.month; }),
            y: tpData.map(function(d) { return d.value; }),
            line: { color: '#dc2626', width: 2, shape: 'spline' },
            marker: { size: 6, color: '#dc2626' },
            fill: 'tozeroy',
            fillcolor: 'rgba(220, 38, 38, 0.07)',
            hovertemplate: '%{x}<br>%{y} pieces<extra></extra>'
        }], {
            xaxis: {
                tickfont: { size: 10, color: '#71717a' },
                tickangle: -30
            },
            yaxis: {
                title: { text: 'Pieces produites', font: { size: 10, color: '#71717a' } },
                tickfont: { size: 10, color: '#71717a' },
                gridcolor: '#f4f4f5'
            },
            margin: { t: 10, b: 60, l: 50, r: 10 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            height: 280
        }, { responsive: true, displayModeBar: false });
    }
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Stock - T'ÉLÉFAN MES 4.0{% endblock %}

{% block header_center %}
<h1 class="text-xl font-bold tracking-widest uppercase text-zinc-900">
    Stock
</h1>
{% endblock %}

{% block breadcrumbs %}
<div class="border-t border-zinc-100 bg-zinc-50/50">
    <div class="max-w-[1400px] mx-auto px-4 py-2 text-sm">
        <a href="{{ url_for('main.dashboard') }}" class="text-zinc-400 hover:text-zinc-600 transition-colors">Accueil</a>
        <span class="mx-1.5 text-zinc-400">&gt;</span>
        <span class="font-medium text-zinc-900">Stock</span>
    </div>
</div>
{% endblock %}

{% block content %}
<h2 class="text-lg font-semibold tracking-tight text-zinc-900 mb-6">Stock</h2>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

    <!-- Taux d'occupation des buffers (Bar Chart) - 60% -->
    <div class="lg:col-span-3 bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1.5 kpi-bar-stock"></div>
        <div class="p-6">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">
                Taux d'occupation des buffers
            </h3>
            <div id="buffer-occ-chart" class="plotly-chart" style="height: 340px;"></div>
        </div>
    </div>

    <!-- Variation du niveau de stock (Bar Chart) - 40% -->
    <div class="lg:col-span-2 bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1.5 kpi-bar-stock"></div>
        <div class="p-6">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">
                Variation du niveau de stock
            </h3>
            <div id="stock-var-chart" class="plotly-chart" style="height: 340px;"></div>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    // --- Buffer Occupancy Bar Chart ---
    var boData = {{ buffer_occ.by_buffer | tojson }};
    if (boData && boData.length > 0) {
        var colors = boData.map(function(d) {
            return d.rate > 90 ? '#ef4444' : '#737373';
        });
        var annotations = [];
        boData.forEach(function(d, i) {
            if (d.rate > 90) {
                annotations.push({
                    x: d.name,
                    y: d.rate,
                    text: '>90%',
                    showarrow: false,
                    yshift: 12,
                    font: { size: 9, color: '#ef4444', weight: 600 }
                });
            }
        });

        Plotly.newPlot('buffer-occ-chart', [{
            type: 'bar',
            x: boData.map(function(d) { return d.name; }),
            y: boData.map(function(d) { return d.rate; }),
            marker: {
                color: colors,
                line: { width: 0 }
            },
            text: boData.map(function(d) { return d.rate.toFixed(1) + '%'; }),
            textposition: 'outside',
            textfont: { size: 9, color: '#71717a' },
            hovertemplate: '%{x}<br>Occupation: %{y:.1f}%<br>Capacite: ' +
                boData.map(function(d) { return d.capacity; }).join(',') + '<extra></extra>'
        }], {
            xaxis: {
                tickfont: { size: 8, color: '#71717a' },
                tickangle: -35
            },
            yaxis: {
                title: { text: 'Occupation (%)', font: { size: 10, color: '#71717a' } },
                range: [0, 105],
                tickfont: { size: 10, color: '#71717a' },
                gridcolor: '#f4f4f5',
                ticksuffix: '%'
            },
            annotations: annotations,
            margin: { t: 10, b: 90, l: 50, r: 10 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            bargap: 0.3,
            height: 340
        }, { responsive: true, displayModeBar: false });
    } else {
        document.getElementById('buffer-occ-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-sm text-zinc-400">' +
            'Aucune donnee de buffer disponible</div>';
    }

    // --- Stock Variation Bar Chart ---
    var svData = {{ stock_var.variations | tojson }};
    if (svData && svData.length > 0) {
        Plotly.newPlot('stock-var-chart', [{
            type: 'bar',
            x: svData.map(function(d) { return d.buffer; }),
            y: svData.map(function(d) { return d.variation_pct; }),
            marker: {
                color: '#737373',
                line: { width: 0 }
            },
            text: svData.map(function(d) { return d.variation_pct.toFixed(1) + '%'; }),
            textposition: 'outside',
            textfont: { size: 9, color: '#71717a' },
            hovertemplate: '%{x}<br>Variation: %{y:.1f}%<extra></extra>'
        }], {
            xaxis: {
                tickfont: { size: 8, color: '#71717a' },
                tickangle: -35
            },
            yaxis: {
                title: { text: 'Variation (%)', font: { size: 10, color: '#71717a' } },
                range: [0, Math.max(25, Math.max.apply(null, svData.map(function(d) { return d.variation_pct; })) * 1.2)],
                tickfont: { size: 10, color: '#71717a' },
                gridcolor: '#f4f4f5',
                ticksuffix: '%'
            },
            shapes: [{
                type: 'line',
                x0: 0, x1: 1, xref: 'paper',
                y0: 20, y1: 20,
                line: { color: '#ef4444', width: 1.5, dash: 'dash' }
            }],
            annotations: [{
                x: 1, xref: 'paper', xanchor: 'right',
                y: 20, yanchor: 'bottom',
                text: 'Alerte 20%',
                showarrow: false,
                font: { size: 9, color: '#ef4444' }
            }],
            margin: { t: 10, b: 90, l: 50, r: 10 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            bargap: 0.3,
            height: 340
        }, { responsive: true, displayModeBar: false });
    } else {
        document.getElementById('stock-var-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-sm text-zinc-400">' +
            'Aucune donnee de variation de stock disponible</div>';
    }
</script>
{% endblock %}

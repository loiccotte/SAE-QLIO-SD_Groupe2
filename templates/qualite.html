{% extends "base.html" %}

{% block title %}Qualite - T'ELEFAN MES 4.0{% endblock %}

{% block breadcrumbs %}
<div class="border-t border-zinc-100 bg-zinc-50/50">
    <div class="max-w-[1400px] mx-auto px-4 py-2 text-sm">
        <a href="{{ url_for('main.dashboard') }}" class="text-zinc-400 hover:text-zinc-600 transition-colors">Accueil</a>
        <span class="mx-1.5 text-zinc-300">/</span>
        <span class="font-medium text-zinc-900">Qualite</span>
    </div>
</div>
{% endblock %}

{% block content %}
<h2 class="text-lg font-semibold tracking-tight text-zinc-900 mb-6">Qualite</h2>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Taux de non-conformite (Gauge) -->
    <div class="bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1 kpi-bar-qualite"></div>
        <div class="p-6">
            <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-4">
                Taux de non-conformite
            </h3>
            <div id="nc-gauge" class="plotly-chart" style="height: 260px;"></div>
            <!-- Detail des sources -->
            <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-zinc-100">
                <div class="text-center">
                    <p class="text-[10px] text-zinc-400 uppercase tracking-wide">Ordres de production</p>
                    <p class="text-lg font-semibold font-mono text-zinc-900">{{ non_conformity.rate_orders }}%</p>
                    <p class="text-[10px] text-zinc-400">{{ non_conformity.total_pieces }} pieces</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] text-zinc-400 uppercase tracking-wide">Rapports detection</p>
                    <p class="text-lg font-semibold font-mono text-zinc-900">{{ non_conformity.rate_parts }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Temps de detection defaut (Bar Chart) -->
    <div class="bg-white rounded-2xl border border-zinc-200/50
                shadow-[0_4px_12px_-4px_rgba(0,0,0,0.04)] overflow-hidden">
        <div class="h-1 kpi-bar-qualite"></div>
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider">
                    Temps de detection defaut
                </h3>
                <div class="flex items-center gap-1.5">
                    <span class="text-sm font-semibold font-mono text-zinc-900">
                        {{ detection_time.value }}s
                    </span>
                    <span class="text-[10px] text-zinc-400">moy.</span>
                    {% if detection_time.status == 'critical' %}
                    <span class="alert-blink ml-1">
                        <svg class="w-4 h-4 text-qualite" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                    </span>
                    {% endif %}
                </div>
            </div>
            <div id="detection-chart" class="plotly-chart" style="height: 320px;"></div>
            <p class="text-xs text-zinc-400 mt-3">
                {{ detection_time.count }} evenements detectes
            </p>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Non-conformite Gauge ---
    var ncValue = {{ non_conformity.value | tojson }};
    Plotly.newPlot('nc-gauge', [{
        type: 'indicator',
        mode: 'gauge+number',
        value: ncValue,
        number: {
            suffix: '%',
            font: { size: 42, color: '#18181b' }
        },
        gauge: {
            axis: {
                range: [0, 5],
                tickwidth: 1,
                tickcolor: '#d4d4d8',
                dtick: 1
            },
            bar: { color: '#38b6ff', thickness: 0.75 },
            bgcolor: '#f4f4f5',
            borderwidth: 0,
            steps: [
                { range: [0, 2], color: '#f0fdf4' },
                { range: [2, 3.5], color: '#fffbeb' },
                { range: [3.5, 5], color: '#fef2f2' }
            ],
            threshold: {
                line: { color: '#18181b', width: 3 },
                thickness: 0.8,
                value: 2
            }
        }
    }], {
        margin: { t: 10, b: 10, l: 40, r: 40 },
        paper_bgcolor: 'transparent',
        height: 260
    }, { responsive: true, displayModeBar: false });

    // --- Detection Time Bar Chart ---
    var dtData = {{ detection_time.by_event | tojson }};
    if (dtData && dtData.length > 0) {
        Plotly.newPlot('detection-chart', [{
            type: 'bar',
            x: dtData.map(function(d, i) { return d.machine + ' #' + (i + 1); }),
            y: dtData.map(function(d) { return d.seconds; }),
            marker: {
                color: dtData.map(function(d) {
                    if (d.seconds > 10) return '#38b6ff';
                    return '#93d5ff';
                }),
                line: { width: 0 }
            },
            text: dtData.map(function(d) { return d.seconds + 's'; }),
            textposition: 'outside',
            textfont: { size: 9, color: '#71717a' },
            hovertemplate: '%{x}<br>Duree: %{y:.1f}s<extra></extra>'
        }], {
            xaxis: {
                tickfont: { size: 8, color: '#71717a' },
                tickangle: -45
            },
            yaxis: {
                title: { text: 'Secondes', font: { size: 10, color: '#a1a1aa' } },
                tickfont: { size: 10, color: '#a1a1aa' },
                gridcolor: '#f4f4f5'
            },
            shapes: [{
                type: 'line',
                x0: 0, x1: 1, xref: 'paper',
                y0: 10, y1: 10,
                line: { color: '#ef4444', width: 1.5, dash: 'dash' }
            }],
            annotations: [{
                x: 1, xref: 'paper', xanchor: 'right',
                y: 10, yanchor: 'bottom',
                text: 'Seuil 10s',
                showarrow: false,
                font: { size: 9, color: '#ef4444' }
            }],
            margin: { t: 10, b: 100, l: 45, r: 10 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            bargap: 0.3,
            height: 320
        }, { responsive: true, displayModeBar: false });
    } else {
        document.getElementById('detection-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-sm text-zinc-400">' +
            'Aucun evenement de detection enregistre</div>';
    }
</script>
{% endblock %}
